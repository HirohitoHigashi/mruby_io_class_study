# UART

* 非同期シリアル通信をサポートするクラス。

------------------------------------------------------------
## コンストラクタ
----------------------------------------
### UART.new( id=nil, *params )

* id で示す物理ユニットを指定して、UART オブジェクトを生成する。
* パラメータデフォルト値は、可能であれば以下の設定に従う。
  * ボーレート 9600
  * データ8ビット
  * ストップビット1ビット
  * パリティー無し
  * フロー制御無し

オプションパラメータ

| param | type | description |
|-|-|-|
| baudrate | Integer | ボーレート (default 9600) |
| baud | Integer | 同上 |
| data_bits | Integer | データビット (defult 8) |
| stop_bits | Integer | ストップビット (default 1) |
| parity | Const | パリティービット (default NONE) |
| flow_control | Const | フロー制御 (default NONE) |
| unit | --- | ユニットの指定（パラメータidと同じ） |
| txd_pin | --- | TxDピンの指定 |
| rxd_pin | --- | RxDピンの指定 |
| rtx_pin | --- | RTSピンの指定 |
| cts_pin | --- | CTSピンの指定 |

パラメータ用定数
```ruby
UART::NONE
UART::EVEN
UART::ODD
UART::RTSCTS
```

実行例
```ruby
# UART1を、全てデフォルトパラメータで使う。
uart1 = UART.new( 1 )

# 指定したデバイスノードを持つシリアルデバイスを、19200bps 偶数パリティーで使う。
uart2 = UART.new("/dev/cu.usbserial1", baud:19200, parity:UART::EVEN )
```

機種依存
* 全てのパラメータがサポートされているとは限らない。


------------------------------------------------------------
## インスタンスメソッド
----------------------------------------
### setmode( *params )

* UARTのモード（パラメータ）を任意のタイミングで変更する。

実行例
```ruby
uart1.setmode( bardrate:38400 )
```

----------------------------------------
### read( read_bytes=nil ) -> String

* read_bytes で指定されたバイト数のデータを読み込む。
* 指定されたバイト数のデータが到着していない場合、ヌルストリングを返す。
* read_bytes が指定されなければ、リードバッファに到着している全データを返す。データがなければヌルストリングを返す。

実行例
```ruby
val = uart1.read( 10 )
```

ノート
* CRuby の gets は文字列が帰るまでブロックするが、当メソッドはブロックしない。

----------------------------------------
### read_nonblock( read_bytes ) -> String

* リードバッファに到着しているデータを、引数で指定した read_bytes を最大値として返す。
* リードバッファが空ならば、ヌルストリングを返す。

実行例
```ruby
val = uart1.read_nonblock( 1024 ) 
```

----------------------------------------
### bytes_available() -> Integer

* リードバッファに到着している読み込み可能バイト数を返す。

実行例
```ruby
len = uart1.bytes_available()
```

----------------------------------------
### gets() -> String

* 文字列を一行読み込む。内部的にはリードバッファ内の "\n" までのバイト列を返す。
* リードバッファに "\n" が無い場合、ヌルストリングを返す。

実行例
```ruby
val = uart1.gets()
```

ノート
* CRuby の gets は文字列が帰るまでブロックするが、当メソッドはブロックしない。
* 最大文字長はリードバッファのサイズに左右され、過大に大きなサイズが返ることは無いが、改行文字が入らないデータでバッファフルになった場合、gets で読み込むことはできないだろう。

----------------------------------------
### write( string ) -> Integer

* データを送信する。
* データを送信完了するまで、ブロックする。

実行例
```ruby
uart1.write("Output string\r\n")
```

機種依存
* 利用する低レイヤーライブラリやハードウェアFIFOなどにより、全データの送信完了を待たずに戻る場合がある。

----------------------------------------
### flush()

* 送信バッファに溜まったデータの送信完了までブロックする。
  
実行例
```ruby
uart1.flush()
```

----------------------------------------
### clear_rx_buffer()

* 受信バッファをクリアする。

実行例
```ruby
uart1.clear_rx_buffer()
```

----------------------------------------
### clear_tx_buffer()

* 送信バッファをクリアする。

実行例
```ruby
uart1.clear_tx_buffer()
```

----------------------------------------
### break( time )

* break 信号を送信する。
* time はオプションで、秒で指定する。

実行例
```ruby
uart1.break( 0.1 )
```

機種依存
* ハードウェアによっては、timeは一律（e.g. 12bit）で、変更できない。
